<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Draw Pro - UI Update</title>
    <style>
        :root { 
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --panel-bg-blur: rgba(30, 41, 59, 0.85);
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.4);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b; 
            --border: rgba(255,255,255,0.1);
            --radius-lg: 16px;
            --radius-pill: 50px;
            --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        body { 
            margin: 0; padding: 0; display: flex; flex-direction: column; 
            height: 100vh; background: var(--bg-dark); 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; color: var(--text-main);
        }

        /* =========================================
           LOBBY / START SCREEN STYLES
           ========================================= */
        #lobby-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 10%, #1e293b 0%, #020617 100%);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .lobby-content {
            text-align: center;
            animation: lobbyFadeIn 0.8s ease-out;
            position: relative;
            z-index: 2;
        }

        .lobby-title {
            font-size: 3.5rem; font-weight: 800; margin-bottom: 10px;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .lobby-subtitle {
            font-size: 1.1rem; color: var(--text-muted); margin-bottom: 50px;
            font-weight: 400; letter-spacing: 0.5px;
        }

        .lobby-btn-group {
            display: flex; flex-direction: column; gap: 15px; width: 280px; margin: 0 auto;
        }

        .lobby-btn {
            padding: 18px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: white; font-size: 16px; font-weight: 600;
            border-radius: 12px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .lobby-btn:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .lobby-btn.primary {
            background: var(--accent); border: none;
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        .lobby-btn.primary:hover { background: #2563eb; }

        /* Decorative Circles in Lobby */
        .bg-circle {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.4; z-index: 1;
        }
        .c1 { width: 300px; height: 300px; background: var(--accent); top: -100px; left: -100px; }
        .c2 { width: 400px; height: 400px; background: #7c3aed; bottom: -150px; right: -150px; }

        @keyframes lobbyFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           TOP PRIMARY BAR
           ========================================= */
        #top-bar-primary {
            background: var(--panel-bg);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            z-index: 20;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .palette-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Custom Color Picker */
        .color-wrapper { position: relative; display: flex; align-items: center; gap: 8px; }
        #colorPicker {
            -webkit-appearance: none; border: none; width: 36px; height: 36px;
            border-radius: 50%; padding: 0; overflow: hidden; cursor: pointer;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #colorPicker:hover { transform: scale(1.1); box-shadow: 0 0 0 2px var(--accent); }
        #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
        #colorPicker::-webkit-color-swatch { border: none; }

        #recent-palette { display: flex; gap: 6px; }
        .swatch {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1); cursor: pointer;
            transition: transform 0.2s ease;
        }
        .swatch:hover { transform: scale(1.2); border-color: white; }

        .slider-section {
            display: flex;
            gap: 20px;
        }

        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-size: 10px; font-weight: 700; color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase; }

        input[type="range"] {
            -webkit-appearance: none; width: 100px; height: 6px;
            background: rgba(255,255,255,0.1); border-radius: 10px; outline: none;
            transition: background 0.2s;
        }
        input[type="range"]:hover { background: rgba(255,255,255,0.2); }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: var(--accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: transform 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* =========================================
           SECOND TOOL BAR
           ========================================= */
        #top-bar-secondary {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            border-bottom: 1px solid var(--border);
            z-index: 19;
            overflow-x: auto;
            position: relative;
        }
        #top-bar-secondary::-webkit-scrollbar { display: none; }

        .tool-btn {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid transparent;
            padding: 8px 16px;
            border-radius: var(--radius-pill);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            position: relative;
        }
        
        .tool-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            transform: translateY(-1px);
        }

        .tool-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--accent-glow);
            transform: scale(1.05);
            border-color: transparent;
        }

        /* ----- SHARED POPUP STYLES (Brush, Eraser, Shapes) ----- */
        .tool-popup {
            display: none;
            position: absolute;
            top: 55px;
            left: 0;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 500;
            min-width: 160px;
            backdrop-filter: blur(12px);
            animation: slideDown 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .popup-option {
            display: flex; align-items: center; gap: 8px;
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: none;
            color: #cbd5e1;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            transition: background 0.2s;
            box-sizing: border-box;
        }
        .popup-option:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .popup-option.selected {
            background: var(--accent);
            color: white;
        }
        /* ---------------------------------- */

        .shape-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 15px;
            border-left: 1px solid var(--border);
        }

        .checkbox-pill {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: var(--text-muted);
            cursor: pointer; user-select: none;
        }
        .checkbox-pill input { accent-color: var(--accent); }

        /* =========================================
           MAIN CANVAS AREA
           ========================================= */
        #main-view {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            overflow: hidden;
        }
        
        #canvas-box {
            background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
        }
        canvas { display: block; touch-action: none; cursor: crosshair; }

        /* =========================================
           BOTTOM FLOATING ACTION BAR
           ========================================= */
        #bottom-action-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 650px;
            background: var(--panel-bg-blur);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 10px 15px;
            border-radius: var(--radius-pill);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: var(--shadow-float);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .action-group { display: flex; gap: 8px; align-items: center; }

        .action-btn {
            background: transparent;
            color: var(--text-main);
            border: none;
            padding: 10px 14px;
            border-radius: var(--radius-pill);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .action-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .action-btn:active { transform: scale(0.95); }

        #clearBtn { color: var(--danger); }
        #clearBtn:hover { background: rgba(239, 68, 68, 0.15); }

        #lobbyBtn { 
            background: var(--warning); 
            color: #0f172a; 
            padding: 10px 18px; 
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
            border: 1px solid transparent;
        }
        #lobbyBtn:hover { 
            background: #d97706; 
            color: white;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.5);
        }

        #saveBtn { background: var(--success); color: white; padding: 10px 20px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        #saveBtn:hover { background: #059669; }

        #viewGalleryBtn { background: var(--accent); color: white; padding: 10px 20px; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        #viewGalleryBtn:hover { background: #2563eb; }

        /* =========================================
           MODALS (ALL POPUPS)
           ========================================= */
        #delSelBtn {
            display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--danger); color: white; padding: 12px 24px; border: none;
            border-radius: 50px; font-weight: bold; font-size: 14px;
            box-shadow: var(--shadow-float); z-index: 1000;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        @keyframes popIn { from { transform: translate(-50%, 20px) scale(0.8); opacity: 0; } to { transform: translate(-50%, 0) scale(1); opacity: 1; } }

        #gallery-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); z-index: 200;
            flex-direction: column; padding: 30px; box-sizing: border-box;
            backdrop-filter: blur(5px);
        }
        #gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; overflow-y: auto; margin-top: 20px; }
        
        .g-card {
            background: white; padding: 10px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 8px;
            transition: transform 0.2s;
        }
        .g-card:hover { transform: translateY(-3px); }
        .g-card img { width: 100%; border-radius: 6px; border: 1px solid #ddd; }
        .card-actions { display: flex; gap: 5px; }
        .card-actions button { flex: 1; padding: 6px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; color: white; }

        /* Gallery Buttons */
        .gal-head-btn {
            background:rgba(255,255,255,0.1); border:none; color:white; 
            padding: 8px 16px; border-radius:20px; cursor:pointer; 
            font-size: 13px; font-weight: 500;
            transition: background 0.2s;
        }
        .gal-head-btn:hover { background: rgba(255,255,255,0.2); }
        .gal-back-btn { border: 1px solid rgba(255,255,255,0.2); display:flex; align-items:center; gap:5px; }

        /* Preview Modal */
        #preview-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        #preview-content {
            max-width: 90%; max-height: 80%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border-radius: 8px; overflow: hidden;
            animation: scaleIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        #preview-content img { display: block; width: 100%; height: auto; max-height: 80vh; object-fit: contain; }
        #close-preview {
            position: absolute; top: 20px; right: 20px; width: 45px; height: 45px;
            background: rgba(255,255,255,0.1); color: white; border: none;
            border-radius: 50%; font-size: 24px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        #close-preview:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* =========================================
           GENERIC CONFIRM MODAL (SHARED STYLE)
           ========================================= */
        .modal-overlay {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); 
            z-index: 2000;
            backdrop-filter: blur(6px);
            align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .confirm-box {
            background: #1e293b;
            color: #f1f5f9;
            padding: 24px 30px;
            border-radius: 20px;
            width: 300px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            animation: scaleIn 0.2s forwards;
        }

        .confirm-box h3 {
            margin: 0 0 8px 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .confirm-box p {
            color: #94a3b8;
            margin-bottom: 24px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-confirm-action {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-confirm-action:hover { transform: translateY(-2px); }

        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        .btn-warning { background: var(--warning); color: #1e293b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

        /* Mobile */
        @media (max-width: 600px) {
            #top-bar-primary { padding: 10px; flex-direction: row; gap: 10px; }
            .slider-section { gap: 10px; }
            input[type="range"] { width: 70px; }
            #top-bar-secondary { justify-content: flex-start; padding: 10px; }
            .tool-btn { padding: 6px 12px; font-size: 12px; }
            #bottom-action-bar { width: 95%; padding: 8px 10px; bottom: 20px; }
            .action-btn { padding: 8px 10px; font-size: 12px; }
            #saveBtn, #viewGalleryBtn, #lobbyBtn { padding: 8px 14px; }
            .lobby-title { font-size: 2.5rem; }
            .lobby-subtitle { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div id="brush-popup" class="tool-popup">
        <button class="popup-option selected" id="opt-normal" onclick="setBrushType('normal')">
            <span>üñåÔ∏è</span> Normal Brush
        </button>
        <button class="popup-option" id="opt-special" onclick="setBrushType('special')">
            <span>ü™Ñ</span> Special Brush
        </button>
    </div>

    <div id="eraser-popup" class="tool-popup">
        <button class="popup-option selected" id="opt-eraser-normal" onclick="setEraserType('normal')">
            <span>üßπ</span> Normal Eraser
        </button>
        <button class="popup-option" id="opt-eraser-special" onclick="setEraserType('special')">
            <span>ü´ß</span> Special Eraser
        </button>
    </div>

    <div id="shape-popup" class="tool-popup">
        <button class="popup-option selected" id="opt-shape-none" onclick="setShapeType('none')">
            <span>‚úèÔ∏è</span> Freehand
        </button>
        <button class="popup-option" id="opt-shape-line" onclick="setShapeType('line')">
            <span>üìè</span> Line
        </button>
        <button class="popup-option" id="opt-shape-rect" onclick="setShapeType('rect')">
            <span>‚¨ú</span> Rectangle
        </button>
        <button class="popup-option" id="opt-shape-circle" onclick="setShapeType('circle')">
            <span>‚≠ï</span> Circle
        </button>
    </div>

    <div id="lobby-screen">
        <div class="bg-circle c1"></div>
        <div class="bg-circle c2"></div>
        
        <div class="lobby-content">
            <h1 class="lobby-title">Ultimate Draw Pro</h1>
            <p class="lobby-subtitle">Experience the next generation of digital art.</p>
            
            <div class="lobby-btn-group">
                <button id="lobby-new-btn" class="lobby-btn primary">
                    <span>+</span> Create New Artwork
                </button>
                <button id="lobby-gallery-btn" class="lobby-btn">
                    <span>üñºÔ∏è</span> Open Gallery
                </button>
            </div>
        </div>
    </div>
    <div id="top-bar-primary">
        <div class="palette-section">
            <div class="color-wrapper">
                <input type="color" id="colorPicker" value="#000000" title="Choose Color">
            </div>
            <div id="recent-palette"></div>
        </div>

        <div class="slider-section">
            <div class="control-group">
                <span class="control-label">Size</span>
                <input type="range" id="brushSize" min="1" max="50" value="5">
            </div>
            <div class="control-group">
                <span class="control-label">Opacity</span>
                <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="1">
            </div>
        </div>
    </div>

    <div id="top-bar-secondary">
        <button id="brushBtn" class="tool-btn active">Brush</button>
        <button id="selectBtn" class="tool-btn">Select</button>
        <button id="bucketBtn" class="tool-btn">Fill</button>
        <button id="eraserBtn" class="tool-btn">Eraser</button>
        
        <div class="shape-group">
            <button id="shapeMenuBtn" class="tool-btn" style="min-width: 80px;">Freehand</button>
            
            <label class="checkbox-pill">
                <input type="checkbox" id="fillShape"> Fill
            </label>
            <label class="checkbox-pill">
                <input type="checkbox" id="showGrid"> Grid
            </label>
        </div>
    </div>

    <div id="main-view">
        <div id="canvas-box">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <button id="delSelBtn">üóë DELETE SELECTION</button>

    <div id="bottom-action-bar">
        <div class="action-group">
            <button id="undoBtn" class="action-btn" title="Undo">‚Ü∂</button>
            <button id="redoBtn" class="action-btn" title="Redo">‚Ü∑</button>
            <button id="clearBtn" class="action-btn" title="Clear All">Clear</button>
        </div>
        
        <div class="action-group">
            <button id="lobbyBtn" class="action-btn" title="Back to Lobby">Lobby</button>
            <button id="saveBtn" class="action-btn">Save</button>
            <button id="viewGalleryBtn" class="action-btn">Gallery</button>
        </div>
    </div>

    <div id="lobby-confirm-modal" class="modal-overlay">
        <div class="confirm-box">
            <h3>Return to Lobby?</h3>
            <p>Your current drawing might be unsaved. Are you sure you want to exit?</p>
            <div class="confirm-actions">
                <button id="cancelLobby" class="btn-confirm-action btn-cancel">Cancel</button>
                <button id="confirmLobby" class="btn-confirm-action btn-warning">Yes, Exit</button>
            </div>
        </div>
    </div>

    <div id="clear-confirm-modal" class="modal-overlay">
        <div class="confirm-box">
            <h3 style="color: var(--danger)">Clear Canvas?</h3>
            <p>This will erase your entire drawing. This action cannot be undone easily.</p>
            <div class="confirm-actions">
                <button id="cancelClear" class="btn-confirm-action btn-cancel">Cancel</button>
                <button id="confirmClear" class="btn-confirm-action btn-danger">Yes, Clear All</button>
            </div>
        </div>
    </div>

    <div id="save-success-modal" class="modal-overlay">
        <div class="confirm-box">
            <h3 style="color: var(--success)">Artwork Saved!</h3>
            <p>Your masterpiece has been securely saved to your local gallery.</p>
            <div class="confirm-actions">
                <button id="closeSaveModal" class="btn-confirm-action btn-cancel">OK</button>
                <button id="goToGalleryFromSave" class="btn-confirm-action btn-success">Open Gallery</button>
            </div>
        </div>
    </div>

    <div id="gallery-delete-confirm-modal" class="modal-overlay">
        <div class="confirm-box">
            <h3 style="color: var(--danger)">Delete Artwork?</h3>
            <p>This will permanently remove this drawing from your gallery. This cannot be undone.</p>
            <div class="confirm-actions">
                <button id="cancelGalleryDelete" class="btn-confirm-action btn-cancel">Cancel</button>
                <button id="confirmGalleryDelete" class="btn-confirm-action btn-danger">Yes, Delete</button>
            </div>
        </div>
    </div>

    <div id="gallery-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; color:white; width:100%;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <button id="backToLobbyFromGallery" class="gal-head-btn gal-back-btn">
                    <span>üîô</span> Lobby
                </button>
                <h2 style="margin:0; font-weight:300; font-size: 24px;">My Artworks</h2>
            </div>
            <button onclick="document.getElementById('gallery-modal').style.display='none'" class="gal-head-btn">Create Art üé®</button>
        </div>
        <div id="gallery-grid"></div>
    </div>

    <div id="preview-modal" onclick="closePreview()">
        <button id="close-preview" onclick="closePreview()">‚úï</button>
        <div id="preview-content" onclick="event.stopPropagation()">
            <img id="preview-image" src="" alt="Drawing Preview">
        </div>
    </div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true, alpha: false });
    let drawing = false;
    let startX, startY;
    let snapshot;
    let history = [];
    let redoStack = []; 
    let currentMode = 'brush';
    
    // Track brush type
    let activeBrushType = 'normal'; // 'normal' or 'special'
    
    // Track Eraser Type
    let activeEraserType = 'normal'; // 'normal' or 'special'

    // NEW: Track Shape Type (replacing dropdown)
    let currentShape = 'none'; // 'none' (Freehand), 'line', 'rect', 'circle'

    let isSelecting = false;
    let isMovingSelection = false;
    let selectionRect = null;
    let selectionImage = null;
    
    let startPinchDist = 0;
    let startSelectionRect = null; 

    let recentColors = ['#000000'];
    let pendingDeleteId = null;

    /* ===========================
       LOBBY & NAVIGATION LOGIC
       =========================== */
    const lobby = document.getElementById('lobby-screen');
    const lobbyConfirmModal = document.getElementById('lobby-confirm-modal');
    const clearConfirmModal = document.getElementById('clear-confirm-modal');
    const saveSuccessModal = document.getElementById('save-success-modal');
    const galleryDeleteModal = document.getElementById('gallery-delete-confirm-modal');

    function animateLobbyExit() {
        lobby.style.opacity = '0';
        lobby.style.transform = 'scale(1.1)';
        setTimeout(() => {
            lobby.style.display = 'none';
        }, 500); 
    }

    // Go back to lobby logic
    function goBackToLobby() {
        document.getElementById('gallery-modal').style.display = 'none';
        lobby.style.display = 'flex';
        lobby.style.opacity = '1';
        lobby.style.transform = 'scale(1)';
    }

    document.getElementById('lobby-new-btn').onclick = () => {
        animateLobbyExit();
        forceClear(); 
    };

    document.getElementById('lobby-gallery-btn').onclick = () => {
        lobby.style.display = 'none';
        document.getElementById('viewGalleryBtn').click();
    };

    document.getElementById('backToLobbyFromGallery').onclick = goBackToLobby;

    // --- Lobby Button Logic ---
    document.getElementById('lobbyBtn').onclick = () => {
        lobbyConfirmModal.style.display = 'flex';
    };
    document.getElementById('cancelLobby').onclick = () => {
        lobbyConfirmModal.style.display = 'none';
    };
    document.getElementById('confirmLobby').onclick = () => {
        lobbyConfirmModal.style.display = 'none';
        goBackToLobby();
    };

    // --- Clear Button Logic ---
    document.getElementById('clearBtn').onclick = () => {
        clearConfirmModal.style.display = 'flex';
    };
    document.getElementById('cancelClear').onclick = () => {
        clearConfirmModal.style.display = 'none';
    };
    document.getElementById('confirmClear').onclick = () => {
        forceClear();
        saveState();
        clearConfirmModal.style.display = 'none';
    };

    // --- Gallery Delete Modal Logic ---
    document.getElementById('cancelGalleryDelete').onclick = () => {
        galleryDeleteModal.style.display = 'none';
        pendingDeleteId = null;
    };
    document.getElementById('confirmGalleryDelete').onclick = () => {
        if(pendingDeleteId !== null) {
            let list = JSON.parse(localStorage.getItem('pro_draw_vfinal_bucket') || '[]');
            list = list.filter(i => i.id !== pendingDeleteId);
            localStorage.setItem('pro_draw_vfinal_bucket', JSON.stringify(list));
            document.getElementById('viewGalleryBtn').click(); // Refresh gallery
        }
        galleryDeleteModal.style.display = 'none';
        pendingDeleteId = null;
    };

    /* ===========================
       APP LOGIC
       =========================== */

    function init() {
        const view = document.getElementById('main-view');
        const w = view.clientWidth - 40; 
        const h = view.clientHeight - 40;
        
        canvas.width = w;
        canvas.height = h;
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        forceClear();
        saveState();
        updatePaletteUI();
    }

    function drawGrid() {
        if (!document.getElementById('showGrid').checked) return;
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = "rgba(0,0,0,0.1)"; 
        ctx.lineWidth = 1;
        const spacing = 25;
        for (let x = 0; x <= canvas.width; x += spacing) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
        }
        for (let y = 0; y <= canvas.height; y += spacing) {
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
        }
        ctx.stroke();
        ctx.restore();
    }

    function updatePaletteUI() {
        const container = document.getElementById('recent-palette');
        container.innerHTML = '';
        recentColors.forEach(clr => {
            const swatch = document.createElement('div');
            swatch.className = 'swatch';
            swatch.style.background = clr;
            swatch.onclick = () => { document.getElementById('colorPicker').value = clr; };
            container.appendChild(swatch);
        });
    }

    document.getElementById('colorPicker').onchange = (e) => {
        const newColor = e.target.value;
        if (!recentColors.includes(newColor)) {
            recentColors.unshift(newColor);
            if (recentColors.length > 6) recentColors.pop();
            updatePaletteUI();
        }
    };

    function resetAlpha() { ctx.globalAlpha = 1.0; }

    function forceClear() {
        resetAlpha();
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawGrid();
    }

    function getXY(e) {
        const r = canvas.getBoundingClientRect();
        const t = (e.touches && e.touches.length > 0) ? e.touches[0] : e;
        return { x: Math.floor(t.clientX - r.left), y: Math.floor(t.clientY - r.top) };
    }

    function getDistance(t1, t2) {
        return Math.sqrt(Math.pow(t2.clientX - t1.clientX, 2) + Math.pow(t2.clientY - t1.clientY, 2));
    }

    function floodFill(startX, startY, fillColor) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const startPos = (startY * canvas.width + startX) * 4;
        const startR = data[startPos];
        const startG = data[startPos + 1];
        const startB = data[startPos + 2];

        const fillR = parseInt(fillColor.slice(1, 3), 16);
        const fillG = parseInt(fillColor.slice(3, 5), 16);
        const fillB = parseInt(fillColor.slice(5, 7), 16);

        if (startR === fillR && startG === fillG && startB === fillB) return;

        const stack = [[startX, startY]];
        while (stack.length > 0) {
            const [x, y] = stack.pop();
            const pos = (y * canvas.width + x) * 4;

            if (data[pos] === startR && data[pos + 1] === startG && data[pos + 2] === startB) {
                data[pos] = fillR;
                data[pos + 1] = fillG;
                data[pos + 2] = fillB;
                data[pos + 3] = 255;

                if (x > 0) stack.push([x - 1, y]);
                if (x < canvas.width - 1) stack.push([x + 1, y]);
                if (y > 0) stack.push([x, y - 1]);
                if (y < canvas.height - 1) stack.push([x, y + 1]);
            }
        }
        ctx.putImageData(imageData, 0, 0);
        saveState();
    }

    // --- POPUP MANAGEMENT FUNCTIONS ---
    function closeAllPopups() {
        document.getElementById('brush-popup').style.display = 'none';
        document.getElementById('eraser-popup').style.display = 'none';
        document.getElementById('shape-popup').style.display = 'none';
    }

    // --- BRUSH POPUP LOGIC ---
    function setBrushType(type) {
        activeBrushType = type;
        currentMode = 'brush';
        
        // Update selection UI inside popup
        document.getElementById('opt-normal').classList.toggle('selected', type === 'normal');
        document.getElementById('opt-special').classList.toggle('selected', type === 'special');
        
        closeAllPopups();
        
        const btn = document.getElementById('brushBtn');
        btn.innerHTML = (type === 'special') ? "Brush (Sp)" : "Brush";
        updateUI();
    }

    // --- ERASER POPUP LOGIC (UPDATED) ---
    function setEraserType(type) {
        activeEraserType = type;
        currentMode = 'eraser';
        
        // Update selection UI inside popup
        document.getElementById('opt-eraser-normal').classList.toggle('selected', type === 'normal');
        document.getElementById('opt-eraser-special').classList.toggle('selected', type === 'special');
        
        closeAllPopups();

        const btn = document.getElementById('eraserBtn');
        btn.innerHTML = (type === 'special') ? "Eraser (Sp)" : "Eraser";
        updateUI();
    }

    // --- SHAPE POPUP LOGIC (NEW) ---
    function setShapeType(type) {
        currentShape = type;
        
        // Ensure we are in a drawing mode (brush or eraser), but usually Shapes imply Brush mode with shape logic
        if (currentMode !== 'eraser') currentMode = 'brush'; 

        // Update UI in popup
        document.getElementById('opt-shape-none').classList.toggle('selected', type === 'none');
        document.getElementById('opt-shape-line').classList.toggle('selected', type === 'line');
        document.getElementById('opt-shape-rect').classList.toggle('selected', type === 'rect');
        document.getElementById('opt-shape-circle').classList.toggle('selected', type === 'circle');

        closeAllPopups();

        // Update button text
        const btn = document.getElementById('shapeMenuBtn');
        const labels = { 'none': 'Freehand', 'line': 'Line', 'rect': 'Rect', 'circle': 'Circle' };
        btn.innerHTML = labels[type] || 'Freehand';
        
        updateUI();
    }

    function startDraw(e) {
        const pos = getXY(e);
        startX = pos.x; 
        startY = pos.y;
        
        // === APPLY OFFSET FOR START POSITION ===
        if (currentMode === 'brush' && activeBrushType === 'special') {
            startY -= 75; 
        }
        if (currentMode === 'eraser' && activeEraserType === 'special') {
            startY -= 75; 
        }
        // ========================================

        if (currentMode === 'bucket') {
            floodFill(pos.x, pos.y, document.getElementById('colorPicker').value);
            return;
        }

        if (currentMode === 'select') {
            document.getElementById('delSelBtn').style.display = 'none';
            if (selectionRect && 
                pos.x >= selectionRect.x && pos.x <= selectionRect.x + selectionRect.w &&
                pos.y >= selectionRect.y && pos.y <= selectionRect.y + selectionRect.h) {
                
                isMovingSelection = true;
                if (!selectionImage) {
                    const tempCanvas = document.createElement('canvas');
                    const sw = Math.abs(selectionRect.w);
                    const sh = Math.abs(selectionRect.h);
                    const sx = selectionRect.w < 0 ? selectionRect.x + selectionRect.w : selectionRect.x;
                    const sy = selectionRect.h < 0 ? selectionRect.y + selectionRect.h : selectionRect.y;
                    
                    tempCanvas.width = sw;
                    tempCanvas.height = sh;
                    const tCtx = tempCanvas.getContext('2d');
                    tCtx.drawImage(canvas, sx, sy, sw, sh, 0, 0, sw, sh);
                    selectionImage = tempCanvas;
                    
                    ctx.save();
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(sx, sy, sw, sh);
                    ctx.restore();
                    snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    selectionRect = { x: sx, y: sy, w: sw, h: sh };
                }
                
                if (e.touches && e.touches.length === 2) {
                    startPinchDist = getDistance(e.touches[0], e.touches[1]);
                    startSelectionRect = { ...selectionRect };
                }
            } else {
                isSelecting = true;
                selectionRect = { x: pos.x, y: pos.y, w: 0, h: 0 };
                selectionImage = null;
                snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            drawing = true;
            return;
        }

        drawing = true;
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = document.getElementById('brushSize').value;
        
        if (currentMode === 'eraser') {
            ctx.globalAlpha = 1.0;
            ctx.strokeStyle = "#ffffff";
            ctx.fillStyle = "#ffffff";
        } else {
            ctx.globalAlpha = document.getElementById('opacity').value;
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.fillStyle = document.getElementById('colorPicker').value;
        }
        
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }

    function drawingMove(e) {
        if(!drawing) return;
        const pos = getXY(e);
        
        let drawX = pos.x;
        let drawY = pos.y;

        // === APPLY OFFSET FOR MOVE POSITION ===
        if (currentMode === 'brush' && activeBrushType === 'special') {
            drawY -= 75; 
        }
        if (currentMode === 'eraser' && activeEraserType === 'special') {
            drawY -= 75;
        }
        // ======================================

        if (currentMode === 'select') {
            ctx.putImageData(snapshot, 0, 0);
            if (isSelecting) {
                selectionRect.w = pos.x - selectionRect.x;
                selectionRect.h = pos.y - selectionRect.y;
                ctx.save();
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
                ctx.restore();
            } else if (isMovingSelection && selectionImage) {
                if (e.touches && e.touches.length === 2) {
                    const currentDist = getDistance(e.touches[0], e.touches[1]);
                    if (startPinchDist > 0) {
                        const ratio = currentDist / startPinchDist;
                        const newW = startSelectionRect.w * ratio;
                        const newH = startSelectionRect.h * ratio;
                        
                        selectionRect.x = (startSelectionRect.x + startSelectionRect.w/2) - newW/2;
                        selectionRect.y = (startSelectionRect.y + startSelectionRect.h/2) - newH/2;
                        selectionRect.w = newW;
                        selectionRect.h = newH;
                    }
                } else {
                    selectionRect.x += (pos.x - startX); // For selection move, we use raw delta
                    selectionRect.y += (pos.y - startY); 
                    startX = pos.x; 
                    startY = pos.y;
                }
                
                ctx.drawImage(selectionImage, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
                ctx.save();
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
                ctx.restore();
            }
            return;
        }

        // --- SHAPE DRAWING LOGIC (UPDATED TO USE currentShape VARIABLE) ---
        const shape = currentShape; // Was document.getElementById('shapeTool').value
        const shouldFill = document.getElementById('fillShape').checked;
        
        if(shape === 'none') {
            ctx.lineTo(drawX, drawY);
            ctx.stroke();
        } else {
            ctx.putImageData(snapshot, 0, 0);
            ctx.beginPath();
            if(shape === 'line') {
                ctx.moveTo(startX, startY); ctx.lineTo(drawX, drawY);
            } else if(shape === 'rect') {
                if(shouldFill || currentMode === 'eraser') ctx.fillRect(startX, startY, drawX - startX, drawY - startY);
                ctx.strokeRect(startX, startY, drawX - startX, drawY - startY);
            } else if(shape === 'circle') {
                let r = Math.sqrt(Math.pow(startX - drawX, 2) + Math.pow(startY - drawY, 2));
                ctx.arc(startX, startY, r, 0, 2 * Math.PI);
                if(shouldFill || currentMode === 'eraser') ctx.fill();
            }
            ctx.stroke();
        }
    }

    function endDraw() { 
        if(drawing) {
            if (currentMode === 'select') {
                if (isMovingSelection) {
                    isMovingSelection = false;
                    ctx.putImageData(snapshot, 0, 0);
                    ctx.drawImage(selectionImage, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
                    selectionImage = null;
                    selectionRect = null;
                    startPinchDist = 0;
                    saveState();
                } else if (isSelecting) {
                    isSelecting = false;
                    if(selectionRect.w < 0) { selectionRect.x += selectionRect.w; selectionRect.w = Math.abs(selectionRect.w); }
                    if(selectionRect.h < 0) { selectionRect.y += selectionRect.h; selectionRect.h = Math.abs(selectionRect.h); }
                    if(Math.abs(selectionRect.w) > 5) {
                        document.getElementById('delSelBtn').style.display = 'block';
                    }
                }
            } else {
                saveState();
            }
            redrawWithState(history[history.length-1]);
        } 
        drawing = false; 
    }

    function saveState() {
        if(history.length > 20) history.shift();
        history.push(canvas.toDataURL());
        redoStack = []; 
    }

    function redrawWithState(url) {
        const img = new Image();
        img.src = url;
        img.onload = () => {
            resetAlpha();
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            drawGrid(); 
        };
    }

    document.getElementById('undoBtn').onclick = () => {
        if(history.length <= 1) return;
        redoStack.push(history.pop()); 
        redrawWithState(history[history.length-1]);
    };

    document.getElementById('redoBtn').onclick = () => {
        if(redoStack.length === 0) return;
        const state = redoStack.pop();
        history.push(state);
        redrawWithState(state);
    };

    document.getElementById('showGrid').onchange = (e) => {
        const selectBtn = document.getElementById('selectBtn');
        if(e.target.checked) {
            selectBtn.style.display = 'none';
            if(currentMode === 'select') {
                currentMode = 'brush';
                updateUI();
            }
        } else {
            selectBtn.style.display = 'inline-block';
        }
        if(history.length > 0) redrawWithState(history[history.length-1]);
    };

    function performDelete() {
        if (currentMode === 'select' && selectionRect) {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
            selectionRect = null;
            document.getElementById('delSelBtn').style.display = 'none';
            saveState();
            redrawWithState(history[history.length-1]);
        }
    }

    document.getElementById('delSelBtn').onclick = performDelete;

    // --- SAVE FUNCTION ---
    document.getElementById('saveBtn').onclick = () => {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tCtx = tempCanvas.getContext('2d');
        tCtx.fillStyle = "#ffffff";
        tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tCtx.drawImage(canvas, 0, 0);
        const data = tempCanvas.toDataURL();
        let list = JSON.parse(localStorage.getItem('pro_draw_vfinal_bucket') || '[]');
        list.unshift({id: Date.now(), img: data});
        localStorage.setItem('pro_draw_vfinal_bucket', JSON.stringify(list.slice(0, 20)));
        
        saveSuccessModal.style.display = 'flex';
    };

    document.getElementById('closeSaveModal').onclick = () => {
        saveSuccessModal.style.display = 'none';
    };
    document.getElementById('goToGalleryFromSave').onclick = () => {
        saveSuccessModal.style.display = 'none';
        document.getElementById('viewGalleryBtn').click();
    };

    document.getElementById('viewGalleryBtn').onclick = () => {
        const grid = document.getElementById('gallery-grid');
        grid.innerHTML = '';
        const list = JSON.parse(localStorage.getItem('pro_draw_vfinal_bucket') || '[]');
        list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'g-card';
            card.innerHTML = `
                <img src="${item.img}">
                <div class="card-actions">
                    <button onclick="previewSaved(${item.id})" style="background:#4b5563; color:white;">View</button>
                    <button onclick="editSaved(${item.id})" style="background:var(--accent); color:white;">Edit</button>
                    <button onclick="deleteSaved(${item.id})" style="background:var(--danger); color:white;">Delete</button>
                </div>`;
            grid.appendChild(card);
        });
        document.getElementById('gallery-modal').style.display = 'flex';
    };

    window.previewSaved = (id) => {
        const list = JSON.parse(localStorage.getItem('pro_draw_vfinal_bucket') || '[]');
        const item = list.find(i => i.id === id);
        if (item) {
            document.getElementById('preview-image').src = item.img;
            document.getElementById('preview-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; 
        }
    };

    window.closePreview = () => {
        document.getElementById('preview-modal').style.display = 'none';
        document.body.style.overflow = '';
    };

    window.editSaved = (id) => {
        const list = JSON.parse(localStorage.getItem('pro_draw_vfinal_bucket') || '[]');
        const item = list.find(i => i.id === id);
        const img = new Image();
        img.src = item.img;
        img.onload = () => {
            resetAlpha(); forceClear();
            ctx.drawImage(img, 0, 0);
            saveState();
            document.getElementById('gallery-modal').style.display = 'none';
        };
    };

    window.deleteSaved = (id) => {
        pendingDeleteId = id;
        galleryDeleteModal.style.display = 'flex';
    };

    canvas.addEventListener('mousedown', startDraw);
    window.addEventListener('mousemove', drawingMove);
    window.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); }, {passive:false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawingMove(e); }, {passive:false});
    canvas.addEventListener('touchend', endDraw);

    // --- BUTTON POPUP HANDLERS ---

    // 1. Brush Button
    document.getElementById('brushBtn').onclick = (e) => { 
        const popup = document.getElementById('brush-popup');
        const btnRect = e.target.getBoundingClientRect();
        
        if(popup.style.display === 'block') {
            popup.style.display = 'none';
        } else {
            closeAllPopups();
            popup.style.left = btnRect.left + 'px';
            popup.style.display = 'block';
        }
        currentMode='brush'; 
        updateUI(); 
    };

    // 2. Select Button
    document.getElementById('selectBtn').onclick = () => { 
        currentMode='select'; 
        closeAllPopups();
        updateUI(); 
    };

    // 3. Bucket Button
    document.getElementById('bucketBtn').onclick = () => { 
        currentMode='bucket'; 
        closeAllPopups(); 
        updateUI(); 
    };
    
    // 4. Eraser Button (NOW OPENS POPUP)
    document.getElementById('eraserBtn').onclick = (e) => {
        const popup = document.getElementById('eraser-popup');
        const btnRect = e.target.getBoundingClientRect();

        if(popup.style.display === 'block') {
            popup.style.display = 'none';
        } else {
            closeAllPopups();
            popup.style.left = btnRect.left + 'px';
            popup.style.display = 'block';
        }
        // Don't set mode immediately, let user pick, or default to last selected eraser logic if they just want to see menu
        // But for UX consistency, we usually highlight the tool:
        currentMode = 'eraser';
        updateUI();
    };

    // 5. Shape/Freehand Button (NEW)
    document.getElementById('shapeMenuBtn').onclick = (e) => {
        const popup = document.getElementById('shape-popup');
        const btnRect = e.target.getBoundingClientRect();
        
        if(popup.style.display === 'block') {
            popup.style.display = 'none';
        } else {
            closeAllPopups();
            popup.style.left = btnRect.left + 'px';
            popup.style.display = 'block';
        }
    };
    
    // Close popups if clicking on canvas or other non-button areas
    document.getElementById('main-view').onclick = () => {
        closeAllPopups();
    };

    function updateUI() {
        document.getElementById('brushBtn').classList.toggle('active', currentMode==='brush' && currentShape === 'none');
        document.getElementById('selectBtn').classList.toggle('active', currentMode==='select');
        document.getElementById('bucketBtn').classList.toggle('active', currentMode==='bucket');
        document.getElementById('eraserBtn').classList.toggle('active', currentMode==='eraser');
        
        // Shape button is active if we are in Brush mode but using a Shape
        const isShapeMode = currentMode === 'brush' && currentShape !== 'none';
        // Or if we just want to highlight it when user is drawing shapes
        
        document.getElementById('delSelBtn').style.display = 'none';
        document.getElementById('shapeMenuBtn').disabled = (currentMode === 'bucket' || currentMode === 'select');
        selectionRect = null;
        if(history.length > 0) redrawWithState(history[history.length-1]);
    }

    window.onload = init;
</script>
</body>
</html>
